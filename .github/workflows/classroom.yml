name: Autograding Tests
'on':
  - push
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # Ð¢ÐµÑÑ‚Ñ‹
    - name: Ð¡Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
      id: add_test
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð¡Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        command: python task.py
        input: |
          5
          +
          3
        expected-output: '8'
        comparison-method: exact
        timeout: 5
        max-score: 15
    
    - name: Ð’Ñ‹Ñ‡Ð¸Ñ‚Ð°Ð½Ð¸Ðµ
      id: sub_test
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð’Ñ‹Ñ‡Ð¸Ñ‚Ð°Ð½Ð¸Ðµ
        command: python task.py
        input: |
          10
          -
          4
        expected-output: '6'
        comparison-method: exact
        timeout: 5
        max-score: 15
    
    - name: Ð£Ð¼Ð½Ð¾Ð¶ÐµÐ½Ð¸Ðµ
      id: mul_test
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð£Ð¼Ð½Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        command: python task.py
        input: |
          7
          *
          6
        expected-output: '42'
        comparison-method: exact
        timeout: 5
        max-score: 15
    
    - name: Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ
      id: div_test
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ
        command: python task.py
        input: |
          15
          /
          3
        expected-output: '5'
        comparison-method: contains
        timeout: 5
        max-score: 15
    
    - name: Ð¡Ñ‚ÐµÐ¿ÐµÐ½ÑŒ
      id: pow_test
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð¡Ñ‚ÐµÐ¿ÐµÐ½ÑŒ
        command: python task.py
        input: |
          2
          ^
          3
        expected-output: '8'
        comparison-method: exact
        timeout: 5
        max-score: 15
    
    - name: Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ Ð½Ð° Ð½Ð¾Ð»ÑŒ
      id: div_zero_test
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ Ð½Ð° Ð½Ð¾Ð»ÑŒ
        command: python task.py
        input: |
          10
          /
          0
        expected-output: 'error'
        comparison-method: contains
        timeout: 5
        max-score: 15
    
    - name: ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ
      id: unk_test
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ
        command: python task.py
        input: |
          5
          %
          3
        expected-output: 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ'
        comparison-method: contains
        timeout: 5
        max-score: 10
    
    # ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
    - name: Extract Scores
      id: extract_scores
      run: |
        # Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¸Ð· base64 Ð¸ Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ score
        decode_and_get_score() {
          local encoded_result="$1"
          echo "$encoded_result" | base64 -d | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['tests'][0]['score'])"
        }
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð±Ð°Ð»Ð»Ñ‹ Ð¸Ð· ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‚ÐµÑÑ‚Ð°
        ADD_SCORE=$(decode_and_get_score '${{ steps.add_test.outputs.result }}')
        SUB_SCORE=$(decode_and_get_score '${{ steps.sub_test.outputs.result }}')
        MUL_SCORE=$(decode_and_get_score '${{ steps.mul_test.outputs.result }}')
        DIV_SCORE=$(decode_and_get_score '${{ steps.div_test.outputs.result }}')
        POW_SCORE=$(decode_and_get_score '${{ steps.pow_test.outputs.result }}')
        DIV_ZERO_SCORE=$(decode_and_get_score '${{ steps.div_zero_test.outputs.result }}')
        UNKNOWN_SCORE=$(decode_and_get_score '${{ steps.unk_test.outputs.result }}')
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² outputs
        echo "add_score=$ADD_SCORE" >> $GITHUB_OUTPUT
        echo "sub_score=$SUB_SCORE" >> $GITHUB_OUTPUT
        echo "mul_score=$MUL_SCORE" >> $GITHUB_OUTPUT
        echo "div_score=$DIV_SCORE" >> $GITHUB_OUTPUT
        echo "pow_score=$POW_SCORE" >> $GITHUB_OUTPUT
        echo "div_zero_score=$DIV_ZERO_SCORE" >> $GITHUB_OUTPUT
        echo "unk_score=$UNKNOWN_SCORE" >> $GITHUB_OUTPUT
        
        # Ð¢Ð°ÐºÐ¶Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð°
        echo "ADD_SCORE=$ADD_SCORE" >> $GITHUB_ENV
        echo "SUB_SCORE=$SUB_SCORE" >> $GITHUB_ENV
        echo "MUL_SCORE=$MUL_SCORE" >> $GITHUB_ENV
        echo "DIV_SCORE=$DIV_SCORE" >> $GITHUB_ENV
        echo "POW_SCORE=$POW_SCORE" >> $GITHUB_ENV
        echo "DIV_ZERO_SCORE=$DIV_ZERO_SCORE" >> $GITHUB_ENV
        echo "UNKNOWN_SCORE=$UNKNOWN_SCORE" >> $GITHUB_ENV
    
    # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð±Ð°Ð»Ð»Ð°Ð¼Ð¸
    - name: Generate Test Report
      run: |
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð· Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ³Ð¾ ÑˆÐ°Ð³Ð°
        ADD_SCORE="${ADD_SCORE:-0}"
        SUB_SCORE="${SUB_SCORE:-0}"
        MUL_SCORE="${MUL_SCORE:-0}"
        DIV_SCORE="${DIV_SCORE:-0}"
        POW_SCORE="${POW_SCORE:-0}"
        DIV_ZERO_SCORE="${DIV_ZERO_SCORE:-0}"
        UNKNOWN_SCORE="${UNKNOWN_SCORE:-0}"
        
        # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ð¸Ñ‚Ð¾Ð³Ð¸
        TOTAL_POINTS=$((ADD_SCORE + SUB_SCORE + MUL_SCORE + DIV_SCORE + POW_SCORE + DIV_ZERO_SCORE + UNKNOWN_SCORE))
        MAX_POINTS=100
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹
        get_status() {
          local score="$1"
          if [ "$score" -gt 0 ]; then
            echo "âœ…"
          else
            echo "âŒ"
          fi
        }
        
        ADD_STATUS=$(get_status "$ADD_SCORE")
        SUB_STATUS=$(get_status "$SUB_SCORE")
        MUL_STATUS=$(get_status "$MUL_SCORE")
        DIV_STATUS=$(get_status "$DIV_SCORE")
        POW_STATUS=$(get_status "$POW_SCORE")
        DIV_ZERO_STATUS=$(get_status "$DIV_ZERO_SCORE")
        UNKNOWN_STATUS=$(get_status "$UNKNOWN_SCORE")
        
        # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
        echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ§ª Ð”ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Ð¢ÐµÑÑ‚ | Ð‘Ð°Ð»Ð»Ñ‹ | ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ | Ð¡Ñ‚Ð°Ñ‚ÑƒÑ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð¡Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ** | $ADD_SCORE | 15 | $ADD_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð’Ñ‹Ñ‡Ð¸Ñ‚Ð°Ð½Ð¸Ðµ** | $SUB_SCORE | 15 | $SUB_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð£Ð¼Ð½Ð¾Ð¶ÐµÐ½Ð¸Ðµ** | $MUL_SCORE | 15 | $MUL_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ** | $DIV_SCORE | 15 | $DIV_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð¡Ñ‚ÐµÐ¿ÐµÐ½ÑŒ** | $POW_SCORE | 15 | $POW_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ Ð½Ð° Ð½Ð¾Ð»ÑŒ** | $DIV_ZERO_SCORE | 15 | $DIV_ZERO_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| **ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ñ** | $UNKNOWN_SCORE | 10 | $UNKNOWN_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ð Ð°ÑÑ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°
        if [ "$MAX_POINTS" -gt 0 ]; then
          PERCENTAGE=$((TOTAL_POINTS * 100 / MAX_POINTS))
        else
          PERCENTAGE=0
        fi
        
        echo "### ðŸ† Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ð’ÑÐµÐ³Ð¾ Ð±Ð°Ð»Ð»Ð¾Ð²:** $TOTAL_POINTS / $MAX_POINTS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ-Ð±Ð°Ñ€
        echo "**ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ:**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "<div style='background: #e1e4e8; border-radius: 4px; height: 20px; width: 100%;'>" >> $GITHUB_STEP_SUMMARY
        echo "  <div style='background: #2ea44f; border-radius: 4px; height: 100%; width: $PERCENTAGE%;'></div>" >> $GITHUB_STEP_SUMMARY
        echo "</div>" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°
        if [ "$TOTAL_POINTS" -eq "$MAX_POINTS" ]; then
          echo "ðŸŽ‰ **ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°! Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!**" >> $GITHUB_STEP_SUMMARY
        elif [ "$PERCENTAGE" -ge 80 ]; then
          echo "ðŸ‘ **Ð¥Ð¾Ñ€Ð¾ÑˆÐ¸Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚! ÐŸÐ¾Ñ‡Ñ‚Ð¸ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹.**" >> $GITHUB_STEP_SUMMARY
        elif [ "$PERCENTAGE" -ge 60 ]; then
          echo "âš ï¸ **Ð•ÑÑ‚ÑŒ Ð½Ð°Ð´ Ñ‡ÐµÐ¼ Ð¿Ð¾Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ÐÑƒÐ¶Ð½Ð¾ ÑÐµÑ€ÑŒÐµÐ·Ð½Ð¾ Ð¿Ð¾Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð½Ð°Ð´ Ð·Ð°Ð´Ð°Ð½Ð¸ÐµÐ¼.**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°*" >> $GITHUB_STEP_SUMMARY